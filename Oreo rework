--// 📦 Services
local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local VirtualInputManager = game:GetService("VirtualInputManager")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")
local UserInputService = game:GetService("UserInputService")

local cam = Workspace.CurrentCamera
local player = Players.LocalPlayer

--// 🆔 Danh sách animation IDs
local animationId1List = {
	["rbxassetid://13532604085"] = true,
	["rbxassetid://10469639222"] = true,
}

local animationId2List = {
	["rbxassetid://10503381238"] = true,
}

local lastTime1 = 0
local lastTime2 = 0
local toggled = false
local camLocked = false

--// 🧩 GUI Toggle
local gui = Instance.new("ScreenGui", game:GetService("CoreGui"))
gui.Name = "ToggleAnimAction"

local toggleBtn = Instance.new("TextButton")
toggleBtn.Size = UDim2.new(0, 100, 0, 40)
toggleBtn.Position = UDim2.new(0, 30, 0, 200)
toggleBtn.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
toggleBtn.TextColor3 = Color3.new(1, 1, 1)
toggleBtn.Text = "Oreo: OFF"
toggleBtn.Font = Enum.Font.Gotham
toggleBtn.TextSize = 16
toggleBtn.Parent = gui

-- 📌 Drag an toàn không nhấn nhầm
local dragging = false
local dragStartPos, initialPos
local clickThreshold = 6

toggleBtn.InputBegan:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
		dragging = true
		dragStartPos = input.Position
		initialPos = toggleBtn.Position
	end
end)

toggleBtn.InputChanged:Connect(function(input)
	if dragging and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
		local delta = input.Position - dragStartPos
		toggleBtn.Position = initialPos + UDim2.new(0, delta.X, 0, delta.Y)
	end
end)

toggleBtn.InputEnded:Connect(function(input)
	if dragging then
		dragging = false
		local moved = (input.Position - dragStartPos).Magnitude
		if moved < clickThreshold then
			-- 👉 Nếu chỉ nhấn (không drag) thì mới toggle
			toggled = not toggled
			toggleBtn.Text = toggled and "Toggle: ON" or "Toggle: OFF"
			toggleBtn.BackgroundColor3 = toggled and Color3.fromRGB(60, 170, 60) or Color3.fromRGB(60, 60, 60)
		end
	end
end)

toggleBtn.InputEnded:Connect(function(input)
	dragging = false
	if canClick then
		toggled = not toggled
		toggleBtn.Text = toggled and "Oreo: ON" or "Oreo: OFF"
		toggleBtn.BackgroundColor3 = toggled and Color3.fromRGB(60, 170, 60) or Color3.fromRGB(60, 60, 60)
	end
end)

local corner = Instance.new("UICorner", toggleBtn)
corner.CornerRadius = UDim.new(0, 12)

toggleBtn.MouseButton1Click:Connect(function()
	toggled = not toggled
	toggleBtn.Text = toggled and "Oreo: ON" or "Oreo: OFF"
	toggleBtn.BackgroundColor3 = toggled and Color3.fromRGB(60, 170, 60) or Color3.fromRGB(60, 60, 60)
end)

--// 📍 Tìm Torso gần nhất
local function findNearestTorso()
	local nearest, minDist = nil, 10
	for _, model in ipairs(Workspace:GetChildren()) do
		if model:IsA("Model") and model ~= player.Character then
			local torso = model:FindFirstChild("Torso") or model:FindFirstChild("UpperTorso")
			if torso and (model:FindFirstChild("Humanoid") or model.Name == "Weakest Dummy") then
				local dist = (torso.Position - player.Character.HumanoidRootPart.Position).Magnitude
				if dist <= minDist then
					minDist = dist
					nearest = torso
				end
			end
		end
	end
	return nearest
end

--// 🔁 Khoá thao tác camera tạm thời
UserInputService.InputChanged:Connect(function(input)
	if camLocked and input.UserInputType == Enum.UserInputType.Touch then
		input:CaptureController() -- Chặn thao tác xoay
	end
end)

--// 📸 Xoay cam về sau
local function swipeCameraBack(char, onFinish)
	local hrp = char:FindFirstChild("HumanoidRootPart")
	if not hrp then return end
	local camOffset = cam.CFrame.Position - hrp.Position
	local dir = Vector3.new(camOffset.X, 0, camOffset.Z).Unit
	local distance = camOffset.Magnitude
	local newPos = hrp.Position - dir * distance + Vector3.new(0, 2, 0)
	local lookAt = hrp.Position + Vector3.new(0, 1.5, 0)
	local newCF = CFrame.new(newPos, lookAt)
	TweenService:Create(cam, TweenInfo.new(0.2), { CFrame = newCF }):Play()
	if onFinish then task.delay(0.2, onFinish) end
end

--// 📸 Xoay body + cam 44.6° sang phải
local function rotateBodyAndCameraRight(char)
	local hrp = char:FindFirstChild("HumanoidRootPart")
	if not hrp then return end

	local yaw = math.rad(44.6)
	local newCF = hrp.CFrame * CFrame.Angles(0, yaw, 0)

	-- Body
	hrp.CFrame = newCF

	-- Camera
	local camOffset = cam.CFrame.Position - hrp.Position
	local dist = camOffset.Magnitude
	local dir = hrp.CFrame.LookVector
	local camPos = hrp.Position - dir * dist + Vector3.new(0, 2, 0)
	local lookAt = hrp.Position + Vector3.new(0, 1.5, 0)
	local camCF = CFrame.new(camPos, lookAt)

	TweenService:Create(cam, TweenInfo.new(0.15), { CFrame = camCF }):Play()

	-- Khóa camera trong 0.2s
	camLocked = true
	task.delay(0.2, function()
		camLocked = false
	end)
end

--// 🎯 Detect animation và xử lý
RunService.Heartbeat:Connect(function()
	if not toggled then return end

	local char = player.Character
	local humanoid = char and char:FindFirstChildWhichIsA("Humanoid")
	local hrp = char and char:FindFirstChild("HumanoidRootPart")
	if not humanoid or not hrp then return end

	for _, anim in pairs(humanoid:GetPlayingAnimationTracks()) do
		local id = anim.Animation and anim.Animation.AnimationId

		if animationId1List[id] and tick() - lastTime1 > 1.2 then
			lastTime1 = tick()
			task.delay(0.1, function()
				rotateBodyAndCameraRight(char)
			end)

		elseif animationId2List[id] and tick() - lastTime2 > 1.5 then
			lastTime2 = tick()
			task.delay(0.3, function()
				local targetTorso = findNearestTorso()
				if targetTorso then
					local toPos = targetTorso.Position + Vector3.new(0, 1.5, 0)
					local newCF = CFrame.new(toPos, toPos + hrp.CFrame.LookVector)
					TweenService:Create(hrp, TweenInfo.new(0.25), { CFrame = newCF }):Play()
					task.wait(0.26)
				end

				-- Nhảy
				hrp.Velocity = Vector3.new(hrp.Velocity.X, 60, hrp.Velocity.Z)

				-- Remote Dash
				local remote = char:FindFirstChild("Communicate")
				if remote then
					local args = {
						{
							["Dash"] = Enum.KeyCode.W,
							["Key"] = Enum.KeyCode.Q,
							["Goal"] = "KeyPress"
						}
					}
					pcall(function()
						remote:FireServer(unpack(args))
					end)
				end

				-- Giữ W → Xoay → Thả
				VirtualInputManager:SendKeyEvent(true, Enum.KeyCode.W, false, game)
				task.wait(0.23)
				swipeCameraBack(char, function()
					task.wait(0.3)
					VirtualInputManager:SendKeyEvent(false, Enum.KeyCode.W, false, game)
				end)
			end)
		end
	end
end)
